<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Informasi Perpustakaan</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">

    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --bg-light: #f3f4f6;
            --white: #ffffff;
            --text-dark: #111827;
            --text-gray: #6b7280;
            --danger: #ef4444;
            --success: #10b981;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-light); margin: 0; display: flex; height: 100vh; color: var(--text-dark); overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 260px; background: var(--white); border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; padding: 20px; }
        .logo { font-size: 1.25rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 10px; margin-bottom: 40px; }
        .menu { list-style: none; padding: 0; margin: 0; flex: 1; }
        .menu li { margin-bottom: 5px; }
        .menu-link { display: flex; align-items: center; gap: 12px; padding: 10px 15px; border-radius: 8px; text-decoration: none; color: var(--text-gray); font-weight: 500; transition: 0.2s; cursor: pointer; }
        .menu-link:hover, .menu-link.active { background-color: #eff6ff; color: var(--primary); }
        
        /* ROLE SWITCHER (Simulasi Auth) */
        .profile-box { margin-top: auto; padding: 15px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; }
        .profile-label { font-size: 0.75rem; color: var(--text-gray); margin-bottom: 5px; display: block; }
        .role-select { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem; outline: none; }

        /* MAIN CONTENT */
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { margin: 0; font-size: 1.5rem; font-weight: 600; }
        .page-subtitle { color: var(--text-gray); font-size: 0.875rem; margin-top: 5px; }

        /* CARDS & TABLES */
        .card { background: var(--white); border-radius: 10px; border: 1px solid #e5e7eb; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        
        /* Form Admin */
        .admin-form { display: none; grid-template-columns: 2fr 2fr 1fr auto; gap: 15px; align-items: end; }
        .admin-form.active { display: grid; }
        .form-group label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 5px; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-family: inherit; box-sizing: border-box; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; font-size: 0.875rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-danger { background: var(--danger); color: white; padding: 6px 12px; }
        .btn-borrow { width: 100%; justify-content: center; background: white; border: 1px solid var(--primary); color: var(--primary); margin-top: 15px; }
        .btn-borrow:hover { background: #eff6ff; }
        .btn-borrow:disabled { border-color: #e5e7eb; color: #d1d5db; cursor: not-allowed; background: #f9fafb; }

        /* GRID BUKU */
        .grid-books { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .book-item { background: white; border: 1px solid #e5e7eb; border-radius: 10px; padding: 20px; display: flex; flex-direction: column; height: 100%; }
        .book-icon { width: 40px; height: 40px; background: #eff6ff; color: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; margin-bottom: 15px; }
        .book-title { font-weight: 600; margin-bottom: 5px; font-size: 1rem; }
        .book-author { font-size: 0.875rem; color: var(--text-gray); margin-bottom: 15px; }
        .stock-badge { display: inline-block; padding: 4px 10px; border-radius: 50px; font-size: 0.75rem; font-weight: 600; background: #d1fae5; color: #065f46; margin-top: auto; width: fit-content; }
        .stock-badge.empty { background: #fee2e2; color: #991b1b; }

        /* TABLE HISTORY */
        table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        th { text-align: left; padding: 12px 15px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: var(--text-gray); }
        td { padding: 12px 15px; border-bottom: 1px solid #e5e7eb; }
        .link-map { color: var(--primary); text-decoration: none; font-weight: 500; }
        .link-map:hover { text-decoration: underline; }

        /* NOTIFICATION */
        #toast { position: fixed; bottom: 30px; right: 30px; background: #1f2937; color: white; padding: 12px 20px; border-radius: 8px; display: none; animation: slideIn 0.3s; z-index: 100; }
        @keyframes slideIn { from{transform: translateY(20px); opacity:0;} to{transform: translateY(0); opacity:1;} }
        
        .hidden { display: none; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="logo"><i class="ri-book-mark-fill"></i> PERPUS APP</div>
        
        <ul class="menu">
            <li onclick="showSection('catalog')">
                <a class="menu-link active" id="link-catalog"><i class="ri-dashboard-line"></i> Katalog Buku</a>
            </li>
            <li onclick="showSection('history')" id="link-history" style="display: none;">
                <a class="menu-link"><i class="ri-history-line"></i> Riwayat & Lokasi</a>
            </li>
        </ul>

        <div class="profile-box">
            <span class="profile-label">Simulasi Login Sebagai:</span>
            <select class="role-select" id="roleSelect" onchange="switchRole()">
                <option value="user">Mahasiswa (User)</option>
                <option value="admin">Administrator</option>
            </select>
        </div>
    </aside>

    <main class="main">
        <header class="header">
            <div>
                <h1 class="page-title" id="pageTitle">Katalog Buku</h1>
                <div class="page-subtitle">Kelola dan pinjam koleksi perpustakaan.</div>
            </div>
            <button class="btn btn-primary" onclick="fetchBooks()" style="padding: 8px 15px;">
                <i class="ri-refresh-line"></i> Refresh Data
            </button>
        </header>

        <div class="card admin-form" id="adminForm">
            <div class="form-group">
                <label>Judul Buku</label>
                <input type="text" id="title" class="form-input" placeholder="Contoh: Pemrograman Web">
            </div>
            <div class="form-group">
                <label>Penulis</label>
                <input type="text" id="author" class="form-input" placeholder="Nama Penulis">
            </div>
            <div class="form-group">
                <label>Stok Awal</label>
                <input type="number" id="stock" class="form-input" value="10">
            </div>
            <button class="btn btn-primary" onclick="createBook()"><i class="ri-save-line"></i> Simpan</button>
        </div>

        <div id="section-catalog">
            <div class="grid-books" id="bookContainer">
                </div>
        </div>

        <div id="section-history" class="card hidden">
            <h3 style="margin-top: 0; margin-bottom: 20px;">Log Peminjaman & Lokasi User</h3>
            <table>
                <thead>
                    <tr>
                        <th>User ID</th>
                        <th>Buku ID</th>
                        <th>Waktu Pinjam</th>
                        <th>Lokasi (GPS)</th>
                    </tr>
                </thead>
                <tbody id="historyBody">
                    </tbody>
            </table>
        </div>
    </main>

    <div id="toast">Notifikasi</div>

    <script>
        const API = 'http://localhost:3000/api';
        let currentRole = 'user'; // Default role

        // --- NAVIGASI UI ---
        function switchRole() {
            currentRole = document.getElementById('roleSelect').value;
            const adminForm = document.getElementById('adminForm');
            const linkHistory = document.getElementById('link-history');
            
            if (currentRole === 'admin') {
                adminForm.classList.add('active');
                linkHistory.style.display = 'block';
                showToast('Mode: Administrator');
            } else {
                adminForm.classList.remove('active');
                linkHistory.style.display = 'none';
                showSection('catalog'); // Paksa balik ke katalog
                showToast('Mode: Mahasiswa');
            }
            fetchBooks(); // Refresh tombol edit/hapus vs pinjam
        }

        function showSection(sectionId) {
            document.getElementById('section-catalog').classList.add('hidden');
            document.getElementById('section-history').classList.add('hidden');
            
            document.getElementById(`section-${sectionId}`).classList.remove('hidden');
            
            // Highlight Menu
            document.querySelectorAll('.menu-link').forEach(el => el.classList.remove('active'));
            if(sectionId === 'catalog') document.getElementById('link-catalog').classList.add('active');
            else document.getElementById('link-history').classList.add('active'); // Trik simpel

            if(sectionId === 'history') fetchLogs();
        }

        // --- READ BOOKS ---
        async function fetchBooks() {
            try {
                const res = await fetch(`${API}/books`);
                const books = await res.json();
                
                const container = document.getElementById('bookContainer');
                container.innerHTML = '';

                books.forEach(book => {
                    const isHabis = book.stock < 1;
                    const card = document.createElement('div');
                    card.className = 'book-item';
                    
                    // Render kartu buku
                    card.innerHTML = `
                        <div class="book-icon"><i class="ri-book-2-fill"></i></div>
                        <div class="book-title">${book.title}</div>
                        <div class="book-author">${book.author}</div>
                        <span class="stock-badge ${isHabis ? 'empty' : ''}">
                            ${isHabis ? 'Stok Habis' : 'Sisa Stok: ' + book.stock}
                        </span>
                        
                        ${currentRole === 'user' ? `
                            <button class="btn btn-borrow" onclick="borrowBook(${book.id})" ${isHabis ? 'disabled' : ''}>
                                ${isHabis ? 'Tidak Tersedia' : '<i class="ri-map-pin-user-line"></i> Pinjam Buku'}
                            </button>
                        ` : `
                            <div style="display:flex; gap:10px; margin-top:15px;">
                                <button class="btn btn-primary" style="flex:1; justify-content:center; background:#f59e0b;" onclick="editBook(${book.id})">Edit</button>
                                <button class="btn btn-danger" style="flex:1; justify-content:center;" onclick="deleteBook(${book.id})">Hapus</button>
                            </div>
                        `}
                    `;
                    container.appendChild(card);
                });
            } catch (e) { console.error("Gagal load buku"); }
        }

        // --- READ HISTORY LOGS (Admin Only) ---
        async function fetchLogs() {
            if(currentRole !== 'admin') return;
            const res = await fetch(`${API}/logs`, { headers: { 'x-user-role': 'admin' } });
            const logs = await res.json();
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '';

            if(logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Belum ada data peminjaman.</td></tr>';
                return;
            }

            logs.forEach(log => {
                const date = new Date(log.borrowDate).toLocaleString();
                const mapsUrl = `https://www.google.com/maps?q=${log.latitude},${log.longitude}`;
                
                tbody.innerHTML += `
                    <tr>
                        <td>User-${log.userId}</td>
                        <td>Buku ID-${log.bookId}</td>
                        <td>${date}</td>
                        <td><a href="${mapsUrl}" target="_blank" class="link-map"><i class="ri-map-pin-fill"></i> Cek Lokasi</a></td>
                    </tr>
                `;
            });
        }

        // --- ACTIONS: CREATE, EDIT, DELETE, BORROW ---
        
        async function createBook() {
            const title = document.getElementById('title').value;
            const author = document.getElementById('author').value;
            const stock = document.getElementById('stock').value;

            if(!title || !author) return showToast('Isi semua data!');

            await fetch(`${API}/books`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-user-role': 'admin' },
                body: JSON.stringify({ title, author, stock })
            });
            showToast('Buku berhasil ditambahkan');
            document.getElementById('title').value = '';
            fetchBooks();
        }

        async function deleteBook(id) {
            if(confirm('Hapus buku ini secara permanen?')) {
                await fetch(`${API}/books/${id}`, { method: 'DELETE', headers: { 'x-user-role': 'admin' } });
                fetchBooks();
                showToast('Buku dihapus');
            }
        }

        async function editBook(id) {
            const newTitle = prompt("Masukkan Judul Baru:");
            if(newTitle) {
                await fetch(`${API}/books/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'x-user-role': 'admin' },
                    body: JSON.stringify({ title: newTitle, author: 'Updated', stock: 10 })
                });
                fetchBooks();
            }
        }

        function borrowBook(id) {
            if(!navigator.geolocation) return showToast('Browser tidak support GPS');
            showToast('Sedang mendeteksi lokasi anda...');

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const res = await fetch(`${API}/borrow`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'x-user-role': 'user', 
                        'x-user-id': '101' // ID User Simulasi
                    },
                    body: JSON.stringify({ 
                        bookId: id, 
                        latitude: pos.coords.latitude, 
                        longitude: pos.coords.longitude 
                    })
                });

                if(res.ok) {
                    showToast('Sukses! Buku berhasil dipinjam.');
                    fetchBooks();
                } else {
                    showToast('Gagal: Stok habis atau error server.');
                }
            }, () => showToast('Gagal ambil lokasi. Izinkan akses GPS!'));
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        // Init Load
        fetchBooks();
    </script>
</body>
</html>